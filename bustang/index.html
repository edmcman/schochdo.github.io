<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Douglas's Leaflet Map</title>
        <link rel="stylesheet" href="styles.css" />
        <script src="script.js"></script>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
        <script src="bustang_core.geojson" type="text/javascript"></script>
        <script src="bustang_stops.geojson" type="text/javascript"></script>
        <script src="https://unpkg.com/pbf@3.0.5/dist/pbf.js"></script>
        <script src="https://unpkg.com/gtfs-realtime-pbf-js-module@1.0.0/gtfs-realtime.browser.proto.js"></script>

    </head>
    <body>
        <div id="map"></div>
        <script>
            var map = L.map('map').setView([39.7, -106.6], 9);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',subdomains: 'abcd',maxZoom: 20}).addTo(map);
            L.geoJSON(bustangcore).addTo(map);
            
            var geojsonMarkerOptions = {
                radius: 4,
                fillColor: "#ff7800",
                color: "#000",
                weight: 1,
                opacity: 1,
                fillOpacity: 1.0
            };
            
            L.geoJSON(bustangstops, {
                pointToLayer: function (feature, latlng) {
                return L.circleMarker(latlng, geojsonMarkerOptions); // The basic style
                }
            }).addTo(map);
            
            // Convert an array of GTFS objects to GeoJSON "Features" array (https://tools.ietf.org/html/rfc7946#section-3.2)
            const gtfsArrayToGeojsonFeatures = (gtfsArray) => {
              return gtfsArray.map((gtfsObject) => {
                // console.log("gtfsObject", gtfsObject);
                return {
                  type: "Feature",
                  properties: {
                    // Depending on your data source, the properties available on "gtfsObject" may be different:
                    label: gtfsObject.vehicle.vehicle.label
                  },
                  geometry: {
                    type: "Point",
                    coordinates: [
                      gtfsObject.vehicle.position.longitude,
                      gtfsObject.vehicle.position.latitude
                    ]
                  }
                };
              });
            };

            const pbfToGeojson = async () => {
                const url = 'https://www.rtd-denver.com/files/bustang/gtfs-rt/Bustang_VehiclePosition.pb';
              let response = await fetch(url);
              if (response.ok) {
                // if HTTP-status is 200-299
                // get the response body (the method explained below)
                const bufferRes = await response.arrayBuffer();
                const pbf = new Pbf(new Uint8Array(bufferRes));
                const obj = FeedMessage.read(pbf);

                // Return the data in GeoJSON format:
                return {
                  type: "FeatureCollection",
                  features: gtfsArrayToGeojsonFeatures(obj.entity)
                };
              } else {
                console.error("error:", response.status);
              }
            };

            const layer = L.geoJSON([], {
              style: function (feature) {
                return {};
              }
            })
              .bindPopup(function (layer) {
                return "Bus: " + layer.feature.properties.label;
              })
              .addTo(map);

            const updateLayer = async (layer) => {
              const locations = await pbfToGeojson();
              layer.addData(locations);
            };

            updateLayer(layer);

        </script>
        

            
        </script>
    </body>
</html>

